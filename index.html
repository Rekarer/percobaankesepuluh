<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pencatat Keterlambatan Murid Melalui Telegram</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0fdf4; 
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        button {
            transition: all 0.15s ease-in-out;
            transform: translateZ(0);
        }
        button:hover{
            text-decoration: underline;
        }
        .logo-labschool {
    /* The logo will take up 20% of the screen width */
    width: 20vw; 
    /* This ensures it doesn't get TOO small or TOO big */
    min-width: 50px;
    max-width: 150px;
    
    /* Auto margins center the element horizontally within its div */
    margin-left: auto;
    margin-right: auto;
    display: block; 
}
    </style>
</head>
<body class="p-2">

    <div class="w-full max-w-lg bg-white shadow-2xl rounded-3xl p-6 md:p-8 space-y-6 border border-green-200 transform transition-all duration-300 hover:shadow-green-300/50">
        <img class="logo-labschool" src="https://cdn.discordapp.com/attachments/1344292178112811079/1451390105322389716/logo-labs.png?ex=695f0c5e&is=695dbade&hm=3723a61b701e2d043522dbe1e5613cd1a237241e243ac599a0151a33b965b130&">
        <h1 class="text-3xl font-extrabold text-green-700 text-center">Pencatat Keterlambatan Atau Izin Sekolah</h1>
        <p class="text-center text-sm text-gray-500">Ucapkan nama, alasannya, pilih kelas, dan kirim data.</p>

        <h2 class="text-xl font-bold text-green-700 pt-2">1. Nama Murid</h2>
        <div class="bg-green-50 border-2 border-green-300/50 rounded-xl p-2 space-y-3 shadow-inner">
            <div id="statusName" class="text-lg font-bold text-green-700">Status Nama: Belum dimulai</div>
            <div class="bg-white p-1 rounded-lg border border-gray-200 min-h-[2.5rem] whitespace-pre-wrap shadow-sm">
                <p id="outputName" class="text-gray-800 text-base font-medium">Tekan tombol 'Ucapkan Nama Murid'.</p>
                <p class="text-gray-400 text-xs mb-1 font-semibold">Hasil Ucapan Nama Murid:</p>
            </div>
            <div class="flex space-x-2">
                <button id="startNameBtn" class="flex-1 px-4 py-2 bg-green-600 text-white font-bold rounded-xl shadow-md shadow-green-400/50 hover:bg-green-700 disabled:opacity-50 disabled:shadow-none">
                    Ucapkan Nama
                </button>
                <button id="stopNameBtn" disabled class="px-4 py-2 bg-red-600 text-white font-bold rounded-xl shadow-md shadow-red-400/50 hover:bg-red-700 disabled:opacity-50 disabled:shadow-none w-1/3">
                    Stop
                </button>
            </div>
        </div>

        <h2 class="text-xl font-bold text-blue-700 pt-4">2. Alasan Keterlambatan Atau Izin</h2>
        <div class="bg-blue-50 border-2 border-blue-300/50 rounded-xl p-2 space-y-3 shadow-inner">
            <div id="statusReason" class="text-lg font-bold text-blue-700">Status Alasan: Belum dimulai</div>
            <div class="bg-white p-1 rounded-lg border border-gray-200 min-h-[0rem] whitespace-pre-wrap shadow-sm">
                <p id="outputReason" class="text-gray-800 text-base font-medium">Tekan tombol 'Ucapkan Alasan Murid'.</p>
                <p class="text-gray-400 text-xs mb-1 font-semibold">Hasil Ucapan Alasan Keterlambatan:</p>
            </div>
            <div class="flex space-x-2">
                <button id="startReasonBtn" class="flex-1 px-4 py-2 bg-blue-600 text-white font-bold rounded-xl shadow-md shadow-blue-400/50 hover:bg-blue-700 disabled:opacity-50 disabled:shadow-none">
                    Ucapkan Alasan
                </button>
                <button id="stopReasonBtn" disabled class="px-4 py-2 bg-red-600 text-white font-bold rounded-xl shadow-md shadow-red-400/50 hover:bg-red-700 disabled:opacity-50 disabled:shadow-none w-1/3">
                    Stop
                </button>
            </div>
        </div>

        <h2 class="text-xl font-bold text-purple-700 pt-4">3. Pilih Kelas</h2>
        <div>
            <label for="classDropdown" class="sr-only">Pilih Kelas Murid:</label>
            <select id="classDropdown" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-purple-500 focus:border-purple-500 shadow-sm text-gray-700">
                <option value="" disabled selected>--- Pilih Kelas ---</option>
                <option value="XI-A">XI-A</option>
                <option value="XI-B">XI-B</option>
                <option value="XI-C">XI-C</option>
                <option value="XI-D">XI-D</option>
                <option value="XI-E">XI-E</option>
                <option value="XI-F">XI-F</option>
                <option value="XI-G">XI-G</option>
                <option value="XI-H">XI-H</option>
                <option value="XI-I">XI-I</option>
            </select>
        </div>
        
        <div class="bg-gray-100 border border-gray-300 rounded-xl p-2 space-y-2 shadow-inner">
            <div id="message" class="text-sm font-medium min-h-[1.25rem] text-center"></div>
        </div>

        <button id="sendBtn" disabled class="w-full px-6 py-3 bg-purple-600 text-white font-extrabold rounded-xl shadow-xl shadow-purple-400/50 hover:bg-purple-700 disabled:opacity-50 disabled:shadow-none">
            4. Kirim Data Keterlambatan
        </button>
        <iframe data-testid="embed-iframe" style="border-radius:12px" src="https://open.spotify.com/embed/track/1cKHdTo9u0ZymJdPGSh6nq?utm_source=generator" width="100%" height="352" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
    </div>

    <script type="text/javascript">
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

        // --- KONFIGURASI TELEGRAM & MAPPING ---
        const TELEGRAM_TOKEN = "8094088254:AAHhx11hS3pBMyWrqjxKrd3oeRbA3joeB5c";
        
        // GANTI PLACEHOLDER DENGAN ID GRUP MASING-MASING
        const GROUP_MAPPING = {
            "XI-A": "-5085538452",
            "XI-B": "-5001094054",
            "XI-C": "-5066075858",
            "XI-D": "-5072132169",
            "XI-E": "-5008603225",
            "XI-F": "-5099735129",
            "XI-G": "-4913369002",
            "XI-H": "-4876614085",
            "XI-I": "-5006716309"
        };

        const PABBLY_WEBHOOK_URL = 'https://connect.pabbly.com/workflow/sendwebhookdata/IjU3NjYwNTY0MDYzZjA0M2Q1MjY4NTUzMDUxMzAi_pc'; 

        // DOM References
        const startNameBtn = document.getElementById("startNameBtn");
        const stopNameBtn = document.getElementById("stopNameBtn");
        const statusNameEl = document.getElementById("statusName");
        const outputNameEl = document.getElementById("outputName");
        const startReasonBtn = document.getElementById("startReasonBtn");
        const stopReasonBtn = document.getElementById("stopReasonBtn");
        const statusReasonEl = document.getElementById("statusReason");
        const outputReasonEl = document.getElementById("outputReason");
        const sendBtn = document.getElementById("sendBtn");
        const messageEl = document.getElementById("message");
        const classDropdown = document.getElementById("classDropdown");

        let rec;
        let lastTranscriptName = "";
        let lastTranscriptReason = "";
        let currentRecordingTarget = null;

        function showMessage(text, type = 'info') {
            messageEl.textContent = text;
            messageEl.classList.remove('text-red-600', 'text-green-600', 'text-blue-600');
            if (type === 'error') messageEl.classList.add('text-red-600');
            else if (type === 'success') messageEl.classList.add('text-green-600');
            else messageEl.classList.add('text-blue-600');
            setTimeout(() => { messageEl.textContent = ""; }, 5000);
        }

        function checkSendButton() {
            const isReady = lastTranscriptName && lastTranscriptReason && classDropdown.value;
            sendBtn.disabled = !isReady;
        }

        if (!SpeechRecognition) {
            outputNameEl.textContent = "Browser tidak mendukung Speech API.";
        } else {
            rec = new SpeechRecognition();
            rec.lang = "id-ID";
            rec.interimResults = false;
            rec.continuous = false; 

            rec.onstart = () => {
                if (currentRecordingTarget === 'name') {
                    statusNameEl.textContent = "Status Nama: üü¢ Mendengarkan...";
                    outputNameEl.textContent = "Sedang mendengarkan...";
                    startNameBtn.disabled = true;
                    stopNameBtn.disabled = false;
                } else {
                    statusReasonEl.textContent = "Status Alasan: üü¢ Mendengarkan...";
                    outputReasonEl.textContent = "Sedang mendengarkan...";
                    startReasonBtn.disabled = true;
                    stopReasonBtn.disabled = false;
                }
            };

            rec.onend = () => {
                if (currentRecordingTarget === 'name') {
                    statusNameEl.textContent = "Status Nama: üü° Selesai.";
                    startNameBtn.disabled = false;
                    stopNameBtn.disabled = true;
                } else {
                    statusReasonEl.textContent = "Status Alasan: üü° Selesai.";
                    startReasonBtn.disabled = false;
                    stopReasonBtn.disabled = true;
                }
                currentRecordingTarget = null;
                checkSendButton();
            };

            rec.onresult = (event) => {
                const text = event.results[0][0].transcript;
                if (currentRecordingTarget === 'name') {
                    lastTranscriptName = text.trim().toUpperCase();
                    outputNameEl.textContent = lastTranscriptName;
                } else {
                    lastTranscriptReason = text.trim();
                    outputReasonEl.textContent = lastTranscriptReason;
                }
            };
        }

        startNameBtn.onclick = () => { currentRecordingTarget = 'name'; rec.start(); };
        stopNameBtn.onclick = () => rec.stop();
        startReasonBtn.onclick = () => { currentRecordingTarget = 'reason'; rec.start(); };
        stopReasonBtn.onclick = () => rec.stop();
        classDropdown.onchange = checkSendButton;

        function getCurrentDateTime() {
            const now = new Date();
            return {
                time: now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false }),
                date: now.toLocaleDateString('id-ID', { year: 'numeric', month: '2-digit', day: '2-digit' })
            };
        }

        // --- FUNGSI KIRIM UTAMA ---
        sendBtn.onclick = async () => {
            const selectedClass = classDropdown.value;
            const targetGroupId = GROUP_MAPPING[selectedClass];
            const dateTime = getCurrentDateTime();

            if (!targetGroupId || targetGroupId.includes("ID_GRUP")) {
                return showMessage(`Error: ID Grup untuk ${selectedClass} belum diatur!`, 'error');
            }

            sendBtn.disabled = true;
            showMessage("Sedang mengirim data...", 'info');

            // 1. Kirim ke Pabbly
            const payload = {
                raw_data: `${dateTime.time}|${lastTranscriptName}|${selectedClass}|${lastTranscriptReason}|${dateTime.date}`,
                nama_murid: lastTranscriptName,
                kelas_murid: selectedClass,
                alasan_keterlambatan: lastTranscriptReason,
                tanggal: dateTime.date,
                waktu: dateTime.time
            };

            try {
                // Eksekusi Pabbly
                await fetch(PABBLY_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                // 2. Eksekusi Telegram (Berdasarkan Grup Kelas)
                const telegramMsg = `üö® *LAPORAN KETERLAMBATAN*\n\n` +
                                    `üìÖ *Tanggal:* ${dateTime.date}\n` +
                                    `‚è∞ *Jam:* ${dateTime.time}\n` +
                                    `üë§ *Nama:* ${lastTranscriptName}\n` +
                                    `üè´ *Kelas:* ${selectedClass}\n` +
                                    `üìù *Alasan:* ${lastTranscriptReason}`;

                await sendToTelegram(targetGroupId, telegramMsg);

                showMessage('‚úÖ Berhasil! Data terkirim ke Pabbly & Grup ' + selectedClass, 'success');
                
                // Reset Form
                lastTranscriptName = ""; lastTranscriptReason = "";
                outputNameEl.textContent = "Tekan tombol 'Ucapkan Nama Murid'.";
                outputReasonEl.textContent = "Tekan tombol 'Ucapkan Alasan Murid'.";
                classDropdown.value = "";
                checkSendButton();

            } catch (error) {
                showMessage("Gagal: " + error.message, 'error');
            } finally {
                sendBtn.disabled = false;
            }
        };

        async function sendToTelegram(chatId, text) {
            const url = `https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`;
            return fetch(url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    chat_id: chatId,
                    text: text,
                    parse_mode: "Markdown"
                })
            });
        }
    </script>
</body>
</html>

